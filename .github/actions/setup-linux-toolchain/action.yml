name: Setup Linux toolchain

inputs:
  arch:
    required: true

runs:
  using: "composite"
  steps:
    - name: Set up environment
      shell: bash
      run: |
        # Construct toolchain URL and set SHA based on arch
        # NOTE: Using LINUX_TOOLCHAIN_* variables from deps.env (loaded by init-version action)
        BASE_URL="https://github.com/godotengine/buildroot/releases/download/${LINUX_TOOLCHAIN_VERSION}"

        if [[ "${{ inputs.arch }}" == "x86_64" ]]; then
          echo "TOOLCHAIN_URL=${BASE_URL}/x86_64-godot-linux-gnu_sdk-buildroot.tar.bz2" >> "$GITHUB_ENV"
          echo "TOOLCHAIN_SHA=${LINUX_TOOLCHAIN_64_SHA}" >> "$GITHUB_ENV"
        elif [[ "${{ inputs.arch }}" == "x86_32" ]]; then
          echo "TOOLCHAIN_URL=${BASE_URL}/i686-godot-linux-gnu_sdk-buildroot.tar.bz2" >> "$GITHUB_ENV"
          echo "TOOLCHAIN_SHA=${LINUX_TOOLCHAIN_32_SHA}" >> "$GITHUB_ENV"
        elif [[ "${{ inputs.arch }}" == "arm64" ]]; then
          echo "TOOLCHAIN_URL=${BASE_URL}/aarch64-godot-linux-gnu_sdk-buildroot.tar.bz2" >> "$GITHUB_ENV"
          echo "TOOLCHAIN_SHA=${LINUX_TOOLCHAIN_ARM64_SHA}" >> "$GITHUB_ENV"
        elif [[ "${{ inputs.arch }}" == "arm32" ]]; then
          echo "TOOLCHAIN_URL=${BASE_URL}/arm-godot-linux-gnueabihf_sdk-buildroot.tar.bz2" >> "$GITHUB_ENV"
          echo "TOOLCHAIN_SHA=${LINUX_TOOLCHAIN_ARM32_SHA}" >> "$GITHUB_ENV"
        fi

    - name: Cache buildroot
      id: cache-buildroot
      uses: actions/cache@v4
      with:
        path: buildroot
        key: ${{env.TOOLCHAIN_SHA}}

    - name: Set up buildroot
      if: steps.cache-buildroot.outputs.cache-hit != 'true'
      shell: bash
      run: |
        mkdir buildroot
        wget ${TOOLCHAIN_URL} -O buildroot/buildroot.tar.bz2
        cd buildroot
        echo "${TOOLCHAIN_SHA}  buildroot.tar.bz2"
        echo "${TOOLCHAIN_SHA}  buildroot.tar.bz2" | shasum --check
        tar -xjf buildroot.tar.bz2 --strip-components=1
        ls -l
        rm buildroot.tar.bz2
        ./relocate-sdk.sh
        cd ..
